; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; See tools/clang/test/CodeGen/cheri/libcxx-filesystem-crash.cpp
; RUN: %cheri_purecap_llc -disable-cheri-addressing-mode-folder=true -o - %s | FileCheck %s -check-prefix NO-ADDRFOLDER
; RUN: %cheri_purecap_llc -disable-cheri-addressing-mode-folder=false -o - %s | FileCheck %s -check-prefix WITH-ADDRFOLDER

%class.duration = type { i32 }
%class.duration.0 = type { i128 }

; Function Attrs: argmemonly nounwind
declare void @llvm.lifetime.start.p200i8(i64, i8 addrspace(200)* nocapture) addrspace(200) #1

; Function Attrs: argmemonly nounwind
declare void @llvm.lifetime.end.p200i8(i64, i8 addrspace(200)* nocapture) addrspace(200) #1

; Function Attrs: nounwind readonly
define i128 @test2(%class.duration.0 addrspace(200)* nocapture readonly dereferenceable(16) %e) local_unnamed_addr addrspace(200) #0 {
; NO-ADDRFOLDER-LABEL: test2:
; NO-ADDRFOLDER:       # %bb.0: # %entry
; NO-ADDRFOLDER-NEXT:    cincoffset $c11, $c11, -[[STACKFRAME_SIZE:16|32]]
; NO-ADDRFOLDER-NEXT:    .cfi_def_cfa_offset [[STACKFRAME_SIZE]]
; NO-ADDRFOLDER-NEXT:    clc $c1, $zero, 0($c3)
; NO-ADDRFOLDER-NEXT:    csc $c1, $zero, 0($c11)
; FIXME: should be able to fold this into the load in SelectionDAG
; NO-ADDRFOLDER-NEXT:    cincoffset $c1, $c11, 8
; NO-ADDRFOLDER-NEXT:    cld $3, $zero, 0($c1)
; NO-ADDRFOLDER-NEXT:    cld $2, $zero, 0($c11)
; NO-ADDRFOLDER-NEXT:    cjr $c17
; NO-ADDRFOLDER-NEXT:    cincoffset $c11, $c11, [[STACKFRAME_SIZE]]
;
; WITH-ADDRFOLDER-LABEL: test2:
; WITH-ADDRFOLDER:       # %bb.0: # %entry
; WITH-ADDRFOLDER-NEXT:    cincoffset $c11, $c11, -[[STACKFRAME_SIZE:16|32]]
; WITH-ADDRFOLDER-NEXT:    .cfi_def_cfa_offset [[STACKFRAME_SIZE]]
; WITH-ADDRFOLDER-NEXT:    clc $c1, $zero, 0($c3)
; WITH-ADDRFOLDER-NEXT:    csc $c1, $zero, 0($c11)
; WITH-ADDRFOLDER-NEXT:    cld $3, $zero, 8($c11)
; WITH-ADDRFOLDER-NEXT:    cld $2, $zero, 0($c11)
; WITH-ADDRFOLDER-NEXT:    cjr $c17
; WITH-ADDRFOLDER-NEXT:    cincoffset $c11, $c11, [[STACKFRAME_SIZE]]
entry:
  %ref.tmp.sroa.0 = alloca i8 addrspace(200)*, align 16, addrspace(200)
  %tmpcast = bitcast i8 addrspace(200)* addrspace(200)* %ref.tmp.sroa.0 to i128 addrspace(200)*
  %ref.tmp.sroa.0.0..sroa_cast4 = bitcast i8 addrspace(200)* addrspace(200)* %ref.tmp.sroa.0 to i8 addrspace(200)*
  call void @llvm.lifetime.start.p200i8(i64 16, i8 addrspace(200)* nonnull %ref.tmp.sroa.0.0..sroa_cast4)
  %0 = bitcast %class.duration.0 addrspace(200)* %e to i8 addrspace(200)* addrspace(200)*
  %1 = load i8 addrspace(200)*, i8 addrspace(200)* addrspace(200)* %0, align 16
  store i8 addrspace(200)* %1, i8 addrspace(200)* addrspace(200)* %ref.tmp.sroa.0, align 16
  %ref.tmp.sroa.0.0.ref.tmp.sroa.0.0. = load i128, i128 addrspace(200)* %tmpcast, align 16
  call void @llvm.lifetime.end.p200i8(i64 16, i8 addrspace(200)* nonnull %ref.tmp.sroa.0.0..sroa_cast4)
  ret i128 %ref.tmp.sroa.0.0.ref.tmp.sroa.0.0.
}
